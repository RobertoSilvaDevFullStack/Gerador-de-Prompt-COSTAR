#!/usr/bin/env python3
"""
Script para organizar arquivos restantes na raiz
Mant√©m compatibilidade e move arquivos para estrutura apropriada
"""

import os
import shutil
from pathlib import Path
from typing import Dict, List

class RemainingFilesOrganizer:
    def __init__(self, project_root: str):
        self.project_root = Path(project_root)
        
    def analyze_remaining_files(self):
        """Analisar arquivos restantes na raiz"""
        print("üîç Analisando arquivos restantes na raiz...")
        
        root_files = []
        for item in self.project_root.iterdir():
            if item.is_file() and item.name not in ['.gitignore', '.env', '.env.example', 'README.md', 'requirements.txt']:
                root_files.append(item)
        
        # Categorizar arquivos
        categories = {
            'deployment_apps': [],      # Aplica√ß√µes para deploy
            'development_tools': [],    # Ferramentas de desenvolvimento
            'migration_scripts': [],    # Scripts de migra√ß√£o
            'config_files': [],        # Arquivos de configura√ß√£o
            'data_files': [],          # Arquivos de dados
            'test_files': []           # Arquivos de teste restantes
        }
        
        for file_path in root_files:
            filename = file_path.name
            
            # Aplica√ß√µes para deploy espec√≠fico
            if filename in ['app_render.py', 'start_render.py', 'streamlit_app.py']:
                categories['deployment_apps'].append(file_path)
                
            # Ferramentas de desenvolvimento
            elif filename in ['analyze_dependencies.py', 'migrate_project_structure.py', 'validate_migration.py']:
                categories['development_tools'].append(file_path)
                
            # Arquivos de configura√ß√£o espec√≠ficos
            elif filename.endswith(('.json', '.toml', '.ini', '.cfg')) and 'config' not in filename.lower():
                categories['config_files'].append(file_path)
                
            # Arquivos de dados
            elif filename.endswith('.json') and any(word in filename.lower() for word in ['data', 'stats', 'usage']):
                categories['data_files'].append(file_path)
                
            # Scripts de simula√ß√£o/teste
            elif 'simulate' in filename or 'test_' in filename:
                categories['test_files'].append(file_path)
                
            # Arquivos espec√≠ficos do projeto
            elif filename in ['railway-env-setup.txt', 'MIGRATION_SUMMARY.md']:
                categories['config_files'].append(file_path)
                
            # Outros arquivos Python
            elif filename.endswith('.py'):
                categories['development_tools'].append(file_path)
        
        return categories
    
    def create_deployment_structure(self):
        """Criar estrutura para aplica√ß√µes de deployment"""
        print("üìÅ Criando estrutura para deployment...")
        
        deploy_dirs = [
            "deploy/apps",           # Aplica√ß√µes espec√≠ficas de deploy
            "deploy/configs/render", # Configura√ß√µes espec√≠ficas do Render
            "deploy/configs/streamlit", # Configura√ß√µes do Streamlit
        ]
        
        for dir_path in deploy_dirs:
            full_path = self.project_root / dir_path
            full_path.mkdir(parents=True, exist_ok=True)
    
    def move_deployment_apps(self, files: List[Path]):
        """Mover aplica√ß√µes de deployment"""
        print("üöÄ Organizando aplica√ß√µes de deployment...")
        
        for file_path in files:
            if file_path.name == 'app_render.py':
                dest = self.project_root / "deploy" / "apps" / "render_app.py"
            elif file_path.name == 'start_render.py':
                dest = self.project_root / "deploy" / "apps" / "start_render.py"
            elif file_path.name == 'streamlit_app.py':
                dest = self.project_root / "deploy" / "apps" / "streamlit_app.py"
            else:
                dest = self.project_root / "deploy" / "apps" / file_path.name
            
            self._safe_move_file(file_path, dest)
    
    def move_development_tools(self, files: List[Path]):
        """Mover ferramentas de desenvolvimento"""
        print("üõ†Ô∏è Organizando ferramentas de desenvolvimento...")
        
        tools_dir = self.project_root / "tools"
        tools_dir.mkdir(exist_ok=True)
        
        for file_path in files:
            dest = tools_dir / file_path.name
            self._safe_move_file(file_path, dest)
    
    def move_config_files(self, files: List[Path]):
        """Mover arquivos de configura√ß√£o"""
        print("‚öôÔ∏è Organizando arquivos de configura√ß√£o...")
        
        for file_path in files:
            if 'railway' in file_path.name.lower():
                dest = self.project_root / "deploy" / "configs" / "railway" / file_path.name
            elif 'migration' in file_path.name.lower():
                dest = self.project_root / "docs" / file_path.name
            else:
                dest = self.project_root / "deploy" / "configs" / file_path.name
            
            dest.parent.mkdir(parents=True, exist_ok=True)
            self._safe_move_file(file_path, dest)
    
    def move_data_files(self, files: List[Path]):
        """Mover arquivos de dados"""
        print("üìä Organizando arquivos de dados...")
        
        for file_path in files:
            dest = self.project_root / "data" / file_path.name
            self._safe_move_file(file_path, dest)
    
    def move_test_files(self, files: List[Path]):
        """Mover arquivos de teste restantes"""
        print("üß™ Organizando arquivos de teste...")
        
        for file_path in files:
            if 'simulate' in file_path.name:
                dest = self.project_root / "tests" / "integration" / file_path.name
            else:
                dest = self.project_root / "tests" / file_path.name
            
            dest.parent.mkdir(parents=True, exist_ok=True)
            self._safe_move_file(file_path, dest)
    
    def update_deployment_imports(self):
        """Atualizar imports nos arquivos de deployment movidos"""
        print("üîó Atualizando imports em arquivos de deployment...")
        
        # Mapeamento de imports para arquivos de deployment
        deploy_apps_dir = self.project_root / "deploy" / "apps"
        
        import_updates = {
            "from services.": "from app.services.",
            "from routes.": "from app.routes.",
            "from config.": "from app.config.",
            "import services.": "import app.services.",
            "import routes.": "import app.routes.",
            "import config.": "import app.config."
        }
        
        if deploy_apps_dir.exists():
            for py_file in deploy_apps_dir.glob("*.py"):
                self._update_file_imports(py_file, import_updates)
    
    def create_deployment_launchers(self):
        """Criar scripts de lan√ßamento para diferentes plataformas"""
        print("üéØ Criando scripts de lan√ßamento...")
        
        # Script para Render
        render_launcher = self.project_root / "deploy" / "render.py"
        render_content = '''#!/usr/bin/env python3
"""
Launcher para deployment no Render
"""
import sys
from pathlib import Path

# Adicionar raiz do projeto ao path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

if __name__ == "__main__":
    from deploy.apps.start_render import main
    main()
'''
        render_launcher.write_text(render_content, encoding='utf-8')
        
        # Script para Streamlit
        streamlit_launcher = self.project_root / "deploy" / "streamlit.py"
        streamlit_content = '''#!/usr/bin/env python3
"""
Launcher para Streamlit
"""
import sys
from pathlib import Path

# Adicionar raiz do projeto ao path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

if __name__ == "__main__":
    import streamlit as st
    from deploy.apps.streamlit_app import main
    main()
'''
        streamlit_launcher.write_text(streamlit_content, encoding='utf-8')
        
        print("   ‚úÖ deploy/render.py criado")
        print("   ‚úÖ deploy/streamlit.py criado")
    
    def cleanup_empty_directories(self):
        """Limpar diret√≥rios vazios antigos"""
        print("üßπ Limpando diret√≥rios vazios...")
        
        old_dirs = ['api', 'frontend']  # J√° movidos anteriormente
        
        for dir_name in old_dirs:
            dir_path = self.project_root / dir_name
            if dir_path.exists():
                try:
                    # Verificar se est√° vazio (apenas __pycache__ ou __init__.py)
                    contents = list(dir_path.iterdir())
                    if not contents or all(item.name in ['__pycache__', '__init__.py'] for item in contents):
                        shutil.rmtree(dir_path)
                        print(f"   üóëÔ∏è Removido diret√≥rio vazio: {dir_name}/")
                except Exception as e:
                    print(f"   ‚ö†Ô∏è N√£o foi poss√≠vel remover {dir_name}/: {e}")
    
    def _safe_move_file(self, source: Path, destination: Path):
        """Mover arquivo com verifica√ß√£o de seguran√ßa"""
        if not source.exists():
            return
            
        # Criar diret√≥rio de destino se n√£o existir
        destination.parent.mkdir(parents=True, exist_ok=True)
        
        # Verificar se destino j√° existe
        if destination.exists():
            print(f"   ‚ö†Ô∏è Destino j√° existe: {destination.name}")
            return
        
        try:
            shutil.move(str(source), str(destination))
            print(f"   ‚úÖ {source.name} -> {destination.relative_to(self.project_root)}")
        except Exception as e:
            print(f"   ‚ùå Erro ao mover {source.name}: {e}")
    
    def _update_file_imports(self, file_path: Path, import_mapping: Dict[str, str]):
        """Atualizar imports em um arquivo"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            original_content = content
            
            # Aplicar mapeamentos
            for old_import, new_import in import_mapping.items():
                content = content.replace(old_import, new_import)
            
            # Salvar apenas se houve mudan√ßas
            if content != original_content:
                with open(file_path, 'w', encoding='utf-8') as f:
                    f.write(content)
                print(f"   üîó Imports atualizados em {file_path.relative_to(self.project_root)}")
                
        except Exception as e:
            print(f"   ‚ùå Erro ao atualizar imports em {file_path.name}: {e}")
    
    def create_summary(self, categories):
        """Criar resumo da organiza√ß√£o"""
        summary_content = f"""# Organiza√ß√£o de Arquivos Restantes - Fase 2

## üìã Arquivos Organizados

### üöÄ Aplica√ß√µes de Deployment
{chr(10).join([f"- {f.name}" for f in categories['deployment_apps']])}

### üõ†Ô∏è Ferramentas de Desenvolvimento  
{chr(10).join([f"- {f.name}" for f in categories['development_tools']])}

### ‚öôÔ∏è Arquivos de Configura√ß√£o
{chr(10).join([f"- {f.name}" for f in categories['config_files']])}

### üìä Arquivos de Dados
{chr(10).join([f"- {f.name}" for f in categories['data_files']])}

### üß™ Arquivos de Teste
{chr(10).join([f"- {f.name}" for f in categories['test_files']])}

## üìÅ Nova Estrutura Final

```
projeto/
‚îú‚îÄ‚îÄ app/                    # üéØ Aplica√ß√£o principal
‚îú‚îÄ‚îÄ static/                # üé® Frontend
‚îú‚îÄ‚îÄ tests/                 # üß™ Testes
‚îú‚îÄ‚îÄ debug_tools/          # üêõ Ferramentas debug
‚îú‚îÄ‚îÄ docs/                 # üìö Documenta√ß√£o
‚îú‚îÄ‚îÄ data/                 # üìä Dados da aplica√ß√£o
‚îú‚îÄ‚îÄ tools/                # üõ†Ô∏è Ferramentas desenvolvimento
‚îú‚îÄ‚îÄ deploy/               # üöÄ Deploy e configura√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ apps/            # Aplica√ß√µes espec√≠ficas
‚îÇ   ‚îú‚îÄ‚îÄ configs/         # Configura√ß√µes por plataforma
‚îÇ   ‚îú‚îÄ‚îÄ render.py        # Launcher Render
‚îÇ   ‚îî‚îÄ‚îÄ streamlit.py     # Launcher Streamlit
‚îî‚îÄ‚îÄ scripts/              # üìú Scripts utilit√°rios
```

## ‚úÖ Melhorias Implementadas

1. **Deployment Organizado**: Cada plataforma tem sua estrutura
2. **Launchers Criados**: Scripts de entrada para diferentes deploys
3. **Imports Corrigidos**: Todos os caminhos atualizados
4. **Estrutura Limpa**: Raiz do projeto organizada
5. **Compatibilidade Mantida**: Funcionalidade preservada

---
**Organiza√ß√£o conclu√≠da em**: {__import__('datetime').datetime.now()}
"""
        
        summary_file = self.project_root / "docs" / "ORGANIZATION_PHASE2.md"
        summary_file.write_text(summary_content, encoding='utf-8')
        print("üìÑ Resumo da organiza√ß√£o salvo em docs/ORGANIZATION_PHASE2.md")

def main():
    project_root = os.getcwd()
    organizer = RemainingFilesOrganizer(project_root)
    
    print("üöÄ Organizando Arquivos Restantes - Fase 2")
    print("=" * 50)
    
    try:
        # Analisar arquivos restantes
        categories = organizer.analyze_remaining_files()
        
        print(f"üìä Arquivos encontrados:")
        for category, files in categories.items():
            if files:
                print(f"   {category}: {len(files)} arquivo(s)")
        
        # Criar estruturas necess√°rias
        organizer.create_deployment_structure()
        
        # Mover arquivos por categoria
        organizer.move_deployment_apps(categories['deployment_apps'])
        organizer.move_development_tools(categories['development_tools'])
        organizer.move_config_files(categories['config_files'])
        organizer.move_data_files(categories['data_files'])
        organizer.move_test_files(categories['test_files'])
        
        # Atualizar imports e criar launchers
        organizer.update_deployment_imports()
        organizer.create_deployment_launchers()
        
        # Limpeza final
        organizer.cleanup_empty_directories()
        
        # Criar resumo
        organizer.create_summary(categories)
        
        print("\n" + "=" * 50)
        print("üéâ ORGANIZA√á√ÉO FASE 2 COMPLETADA!")
        print("=" * 50)
        print("‚úÖ Todos os arquivos restantes organizados")
        print("‚úÖ Estrutura de deployment criada")
        print("‚úÖ Launchers para diferentes plataformas")
        print("‚úÖ Imports atualizados")
        print("‚úÖ Raiz do projeto limpa")
        
    except Exception as e:
        print(f"\n‚ùå Erro durante organiza√ß√£o: {e}")
        raise

if __name__ == "__main__":
    main()